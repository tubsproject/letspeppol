<import from="../../alert/alert"></import>
<import from="./components/invoice-payment-modal"></import>
<import from="./components/invoice-customer-modal"></import>

<main class="container">
    <section class="section active">
        <div class="invoices-main">
            <div class="section-header">
                <div style="display:flex;align-items:center;gap:.5rem">
<!--                        <button class="btn" aria-label="Back to invoices" click.trigger="invoiceContext.clearSelectedInvoice()">← Back</button>-->
                    <h1 style="margin:0" >New invoice</h1>
                </div>
                <div class="editor-header-actions">
                    <button type="button" class="btn" click.trigger="invoiceContext.clearSelectedInvoice()">Discard</button>
                    <button type="button" class="btn" click.trigger="downloadPdf()">Download PDF</button>
                    <button type="button" class="btn primary" click.trigger="sendInvoice()">Send invoice</button>
                </div>
            </div>

            <div class="card composer-card">
                <div class="composer-head">
                    <div style="display: grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap: var(--space-09);">
                        <label class="field">
                            <span>Document</span>
                            <select name="documentType" value.bind="selectedDocumentType" required>
                                <option repeat.for="type of documentTypes" value.bind="type">${type}</option>
                            </select>
                        </label>
                        <label class="field">
                            <span>Invoice number</span>
                            <input type="text" name="docNumber" placeholder.bind="selectedDocumentType === 'Invoice' ? 'INV-2025-0001' : 'CRE-2025-0001'" value.bind="invoiceContext.selectedInvoice.ID" required />
                        </label>
                        <label class="field">
                            <span>Reference</span>
                            <input type="text" name="reference" placeholder="PO-12345" value.bind="invoiceContext.selectedInvoice.BuyerReference" required />
                        </label>
                        <label class="field">
                            <span>Issue Date</span>
                            <input type="date" name="issueDate" value.bind="invoiceContext.selectedInvoice.IssueDate" required />
                        </label>
                        <label class="field">
                            <span>Due Date</span>
                            <input type="date" name="dueDate" value.bind="invoiceContext.selectedInvoice.DueDate" required />
                        </label>
                        <label class="field" if.bind="selectedDocumentType === 'Credit Note'">
                            <span>Invoice Reference</span>
                            <input type="date" name="invoiceReference" value.bind="invoiceContext.selectedInvoice.BillingReference[0].InvoiceDocumentReference" required />
                        </label>
                        <label class="field full">
                            <details>
                                <summary><span>Note (optional)</span></summary>
                                <textarea name="note" style="min-width: 100%" placeholder="Additional notes for this invoice"></textarea>
                            </details>
                        </label>

                    </div>
                    <div>
                        <div class="composer-info" aria-live="polite">
                            <div style="display: flex; flex-direction: row; margin-bottom: var(--space-025)">
                                <h5 style="margin-top: 0; margin-bottom: 0">Customer</h5>
                                <button class="icon-btn" title="Edit" click.trigger="showCustomerModal()">
                                    <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pen-icon lucide-pen"><path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z"/></svg>
                                </button>
                            </div>
                            <span>Name</span>
                            <b>${invoiceContext.selectedInvoice.AccountingCustomerParty.Party.PartyName.Name}</b>
                            <span>Address</span>
                            <b>
                                ${invoiceContext.selectedInvoice.AccountingCustomerParty.Party.PostalAddress.StreetName}<br/>
                                ${invoiceContext.selectedInvoice.AccountingCustomerParty.Party.PostalAddress.CityName}
                                ${invoiceContext.selectedInvoice.AccountingCustomerParty.Party.PostalAddress.PostalZone}
                            </b>
                        </div>
                    </div>
                    <div>
                        <div class="composer-info" aria-live="polite">
                            <div style="display: flex; flex-direction: row; margin-bottom: var(--space-025)">
                                <h5 style="margin-top: 0; margin-bottom: 0">Payment</h5>
                                <button class="icon-btn" title="Edit" click.trigger="showPaymentModal()">
                                    <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pen-icon lucide-pen"><path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z"/></svg>
                                </button>
                            </div>
                            <span>Method</span>
                            <b>${invoiceContext.paymentMeansCodes.find(item => item.value === selectedPaymentMeansCode).__name}</b>
                            <span>Account Name</span>
                            <b>${invoiceContext.selectedInvoice.PaymentMeans.PayeeFinancialAccount.Name ?? '/'}</b>
                            <span>IBAN</span>
                            <b>${invoiceContext.selectedInvoice.PaymentMeans.PayeeFinancialAccount.ID ?? '/'}</b>
                        </div>
                    </div>
                    <div class="head-right">
                        <div class="total-display" aria-live="polite">
                            <span>Subtotal</span>
                            <b>€ ${invoiceContext.selectedInvoice.LegalMonetaryTotal.TaxExclusiveAmount.value.toFixed(2)}</b>
                            <span>Tax</span>
                            <b>€ ${invoiceContext.selectedInvoice.TaxTotal[0].TaxAmount.value.toFixed(2)}</b>
                        </div>
                        <div class="total-display" aria-live="polite">
                            <span>Total</span>
                            <strong>€ ${invoiceContext.selectedInvoice.LegalMonetaryTotal.PayableAmount.value.toFixed(2)}</strong>
                        </div>
                    </div>
                </div>
                <div class="line-items">
                    <div class="line-items-head">
                        <h3>Invoice lines</h3>
                    </div>
                    <div class="table-wrapper">
                        <table class="data-table line-table">
                            <thead>
                            <tr>
                                <th style="width:80px">Pos</th>
                                <th style="width:18%">Name</th>
                                <th>Description</th>
                                <th class="num" style="width:120px">Amount</th>
                                <th class="num" style="width:140px">Unit price</th>
                                <th class="num" style="width:140px">Tax</th>
                                <th class="num" style="width:140px">Total</th>
                                <th class="actions-col" style="width:1%">Actions</th>
                            </tr>
                            </thead>
                            <tbody if.bind="invoiceContext.selectedInvoice">
                                <tr repeat.for="line of invoiceContext.lines">
                                    <td><input class="pos" type="number" min="1" value.bind="line.ID"/></td>
                                    <td><input class="name" type="text" placeholder="Item name" value.bind="line.Item.Name"/></td>
                                    <td><textarea class="description" placeholder="Description" value.bind="line.Item.Description"></textarea></td>
                                    <td class="num">
                                        <template if.bind="line.InvoicedQuantity">
                                            <input class="qty" type="number" min="0" step="1" value.bind="line.InvoicedQuantity.value" change.trigger="calcLineTotal(line)"/>
                                        </template>
                                        <template else>
                                            <input class="qty" type="number" min="0" step="1" value.bind="line.CreditedQuantity.value" change.trigger="calcLineTotal(line)"/>
                                        </template>
                                    </td>
                                    <td class="num"><input class="unitPrice" type="number" min="0" step="0.01" value.bind="line.Price.PriceAmount.value" change.trigger="calcLineTotal(line)"/></td>
                                    <td class="num">
                                        <select value.bind="line.Item.ClassifiedTaxCategory" change.trigger="calcLineTotal(line)">
                                            <option repeat.for="taxCategory of taxCategories" model.bind="taxCategory">${taxCategory.Percent}%</option>
                                        </select>
                                    </td>
                                    <td class="num"><span class="lineTotal">€&nbsp;${line.LineExtensionAmount.value}</span></td>
                                    <td class="actions-col">
                                        <button class="icon-btn" data-action="remove-line" title="Remove" click.trigger="deleteLine(line)">
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash-icon lucide-trash"><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M3 6h18"/><path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <button type="button" class="btn primary" click.trigger="addLine()">+ Add line</button>
            </div>
        </div>


    </section>
</main>

<invoice-payment-modal component.ref="invoicePaymentModal" invoice-context.bind="invoiceContext" selected-payment-means-code.bind="selectedPaymentMeansCode"></invoice-payment-modal>
<invoice-customer-modal component.ref="invoiceCustomerModal" invoice-context.bind="invoiceContext"></invoice-customer-modal>
